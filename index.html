<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>AutoControle ‚Äî Sistema de Gest√£o Veicular</title>
<link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
<link rel="apple-touch-icon" href="favicon.png">

<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>

/* ===== RESET ===== */
*{
  box-sizing:border-box;
}

body{
  font-family:'Segoe UI', Arial, sans-serif;
  margin:0;
  background:#f4f6f9;
  color:#1e293b;
}

/* ===== CONTAINER ===== */
.container{
  max-width:1200px;
  margin:auto;
  padding:30px;
}

/* ===== CARD ===== */
.card{
  background:#ffffff;
  padding:28px;
  border-radius:14px;
  margin-bottom:25px;
  box-shadow:0 8px 24px rgba(0,0,0,.08);
  border:1px solid #e5e7eb;
}

/* ===== TITULOS ===== */
h1{
  margin:0;
  font-size:26px;
  color:#0f172a;
}

h2{
  margin-bottom:15px;
  color:#16a34a;
}

h3{
  margin-bottom:10px;
  color:#0f172a;
}

small{
  color:#64748b;
}

/* ===== BADGE ===== */
.badge{
  display:inline-block;
  background:#ecfdf5;
  color:#16a34a;
  padding:6px 14px;
  border-radius:20px;
  font-size:13px;
  margin-bottom:10px;
  border:1px solid #bbf7d0;
}

/* ===== INPUTS ===== */
input,select,textarea{
  width:100%;
  padding:12px;
  margin-top:6px;
  border-radius:8px;
  border:1px solid #d1d5db;
  background:#ffffff;
  font-size:14px;
  transition:0.2s;
}

input:focus,select:focus,textarea:focus{
  outline:none;
  border-color:#16a34a;
  box-shadow:0 0 0 2px rgba(22,163,74,.15);
}

/* ===== BOT√ïES ===== */
button{
  background:#16a34a;
  color:white;
  padding:14px;
  border:none;
  border-radius:10px;
  font-weight:bold;
  margin-top:15px;
  cursor:pointer;
  transition:0.2s;
}

button:hover{
  background:#15803d;
  box-shadow:0 6px 18px rgba(22,163,74,.25);
}

/* ===== TABS ===== */
.tabs{
  display:flex;
  gap:15px;
  margin-bottom:30px;
  flex-wrap:wrap;
}

.tabs button{
  background:#2563eb;
}

.tabs button:hover{
  background:#1d4ed8;
}

/* ===== GRID ===== */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:18px;
}

/* ===== TABELAS ===== */
table{
  width:100%;
  border-collapse:collapse;
  background:#ffffff;
  margin-top:10px;
}

th{
  background:#f1f5f9;
  padding:10px;
  text-align:left;
  border-bottom:2px solid #e2e8f0;
  font-weight:600;
}

td{
  padding:8px;
  border-bottom:1px solid #e2e8f0;
}

/* ===== LOGIN E CAPA ===== */
#telaLogin,
#capa{
  background:#f4f6f9;
}

#telaLogin > div,
#capa > div{
  background:#ffffff;
  border-radius:18px;
  padding:30px;
  box-shadow:0 20px 60px rgba(0,0,0,.12);
  border:1px solid #e5e7eb;
}

/* ===== PRINT ===== */
@media print{
  button{
    display:none;
  }
  body{
    background:white;
  }
}

</style>
</head>

<body>
<div id="telaLogin" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:99999;padding:24px;">

  <div style="max-width:400px;width:100%;background:rgba(255,255,255,.06);padding:25px;border-radius:15px;">
    <div style="display:flex;align-items:center;justify-content:center;gap:10px;">
  <img src="logo.png" style="height:35px;">
  <h2>Login AutoControle</h2>
</div>

    <input id="login_usuario" placeholder="Usu√°rio">
    <input id="login_senha" type="password" placeholder="Senha">
    <button onclick="fazerLogin()">Entrar</button>
  </div>
</div>

<!-- CAPA (TELA INICIAL) -->
<div id="capa" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999;padding:24px;">

  <div style="max-width:780px;width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:28px;">
    <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap;">
      <div style="width:56px;height:56px;border-radius:14px;background:#16a34a;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:20px;">
        AC
      </div>
      <div>
        <div style="font-size:28px;font-weight:800;line-height:1.1;">AutoControle</div>
        <div style="opacity:.85;margin-top:4px;">Sistema de Gest√£o Veicular</div>
      </div>
    </div>

    <div style="margin-top:18px;opacity:.92;line-height:1.6;">
      <b>Criado por:</b> PROMETHEUS EROPRO Solu√ß√µes Inteligentes LTDA<br>
      <b>Respons√°vel:</b> Edgar Rocha Oliveira<br>
      <b>Contato:</b> 28 99969-2303 ‚Ä¢ assistentes.prometheus@gmail.com
    </div>

    <button onclick="entrarSistema()" style="margin-top:18px;width:100%;background:#16a34a;border:none;color:#fff;padding:14px;border-radius:12px;font-weight:800;cursor:pointer;">
      Entrar no Sistema
    </button>

    <div style="margin-top:10px;font-size:12px;opacity:.7;">
      √öltima atualiza√ß√£o: <span id="capaAtualizacao"></span>
    </div>
  </div>
</div>


<div class="container">
<div class="card" style="margin-bottom:20px;text-align:center;">
  
  <div style="display:flex;align-items:center;justify-content:center;gap:10px;">
  <img src="logo.png" style="height:35px;">
  <h1 style="margin:0;font-size:26px;">
    AutoControle ‚Äî Sistema de Gest√£o Veicular
  </h1>
</div>

  <h2 id="nomeLojaTopo" style="margin:8px 0 4px 0;font-size:20px;color:#16a34a;">
  </h2>

  <small style="font-size:14px;color:#64748b;">
    Tecnologia com Consci√™ncIA gera resultado
  </small>

</div>

<div class="tabs">
  <button onclick="abrirAba('abaVeiculo')">Ve√≠culo (Entrada)</button>
  <button onclick="abrirAba('abaDespesas')">Despesas</button>
  <button onclick="abrirAba('abaVenda')">Venda</button>
  <button onclick="acessarProprietario()">Painel Propriet√°rio</button>
  <button onclick="abrirAba('abaRelatorio')">Relat√≥rios</button>
  <button onclick="window.open('ficha_entrada.html','_blank')">
Imprimir Ficha em Branco
</button>


</div>

<!-- =======================
  ABA VE√çCULO (ENTRADA)
======================= -->
<div id="abaVeiculo" class="aba" style="display:block">
  <div class="card">


    <h2>Entrada do Ve√≠culo</h2>
    <small>Cadastro do ve√≠culo + dono no documento + vendedor (pode ser diferente).</small>

    <hr>
    <div class="badge">Dados do Ve√≠culo</div>
    <div class="grid">
      <input id="v_placa" placeholder="Placa">
      <input id="v_marca" placeholder="Marca">
      <input id="v_modelo" placeholder="Modelo">
      <input id="v_ano_fabricacao" placeholder="Ano Fabrica√ß√£o">
      <input id="v_ano_modelo" placeholder="Ano Modelo">
      <input id="v_cor" placeholder="Cor">
      <input id="v_combustivel" placeholder="Combust√≠vel">
      <input id="v_chassi" placeholder="Chassi">
      <input id="v_renavam" placeholder="Renavam">
      <input id="v_valor_compra" placeholder="Valor da Compra (R$)">
      <input id="v_valor_venda" placeholder="Valor para Venda (R$)">
<div class="campo">
  <label>Tipo de Ve√≠culo</label>
  <select id="tipo_veiculo">
    <option value="">Selecione</option>
    <option value="MOTO">Moto</option>
    <option value="CARRO">Carro</option>
    <option value="CAMIONETE">Camionete</option> 
    <option value="CAMINHAO">Caminh√£o</option>
    <option value="QUADRICICLO">Quadriciclo</option>
  </select>
</div>

    </div>

    <hr>
    <div class="badge">Dono no Documento (Propriet√°rio Atual)</div>
<div class="grid">
  <input id="p_nome" placeholder="Nome Propriet√°rio">
  <input id="p_cpf" placeholder="CPF/CNPJ Propriet√°rio">
  <input id="p_rg" placeholder="RG Propriet√°rio">

  <div>
    <label>Data de Nascimento do Propriet√°rio</label>
    <input id="p_nascimento" type="date">
  </div>

  <input id="p_telefone" placeholder="Telefone">
  <input id="p_email" placeholder="Email">
  <input id="p_endereco" placeholder="Endere√ßo" style="grid-column: 1 / -1;">

<input id="p_cidade" placeholder="Cidade">
<input id="p_estado" placeholder="UF">

<div>
  <label>Data de Entrada do Ve√≠culo no Estoque</label>
  <input id="p_inicio" type="date">
</div>
</div>
    <hr>
    <div class="badge">Vendedor Anterior (Quem vendeu para a loja)</div>
    <div class="grid">
      <input id="va_nome" placeholder="Nome Vendedor Anterior">
      <input id="va_doc" placeholder="CPF/CNPJ Vendedor">
      <input id="va_telefone" placeholder="Telefone">
      <input id="va_email" placeholder="Email">
      <input id="va_endereco" placeholder="Endere√ßo">
      <input id="va_cidade" placeholder="Cidade">
      <input id="va_estado" placeholder="Estado">
     

    </div>

    <button onclick="salvarEntrada()">Salvar Entrada do Ve√≠culo</button>
  </div>
</div>

<!-- =======================
  ABA DESPESA
======================= -->
<div id="abaDespesas" class="aba" style="display:none;">

 <div class="card">
    <h2>Lan√ßar Despesa</h2>
    <small>Voc√™ pode lan√ßar quantas despesas quiser para o mesmo ve√≠culo.</small>
    <div class="grid">
      <select id="d_id_veiculo"></select>
      <div>
  <label>Data da Despesa</label>
  <input id="d_data" type="date">
</div>

      <input id="d_tipo" placeholder="Tipo (Ex: oficina, IPVA, transfer√™ncia)">
      <input id="d_desc" placeholder="Descri√ß√£o">
      <input id="d_valor" placeholder="Valor (R$)">
    <select id="d_forma">
  <option value="">Forma Pagamento</option>
  <option>Dinheiro</option>
  <option>Pix</option>
  <option>Cart√£o</option>
  <option>Boleto</option>
</select>

<input id="d_comprovante" placeholder="Comprovante (URL / n¬∫ NF / texto)">
</div>
    <button onclick="lancarDespesa()">Lan√ßar Despesa</button>
  </div>
</div>


<!-- =======================
  ABA VENDA
======================= -->
<div id="abaVenda" class="aba" style="display:none;">

  <div class="card">
    <h2>Registrar Venda</h2>
    <small>Obrigat√≥rio ter comprador. Se n√£o houver despesas, o sistema pergunta se deseja continuar.</small>

    <hr>

    <!-- Sele√ß√£o Ve√≠culo e Vendedor -->
    <div class="badge">Selecionar ve√≠culo e vendedor</div>
    <div class="grid">
      <select id="vd_id_veiculo"></select>

      <select id="vd_vendedor_loja"></select>

      <select id="vd_tipo_comissao">
        <option value="PERCENTUAL">Comiss√£o por %</option>
        <option value="FIXO">Comiss√£o fixa (R$)</option>
      </select>

      <input id="vd_percentual" placeholder="% Comiss√£o (se percentual)">
      <input id="vd_valor_comissao" placeholder="Valor Comiss√£o (se fixa)">
    </div>

    <hr>

    <!-- Cadastro Vendedor Loja -->
    <div class="badge">Cadastrar vendedor da loja</div>
    <div class="grid">
      <input id="vl_nome" placeholder="Nome do vendedor">
      <input id="vl_cpf" placeholder="CPF do vendedor">
      <input id="vl_tel" placeholder="Telefone">
      <input id="vl_email" placeholder="Email">
      <input id="vl_cargo" placeholder="Cargo (ex: vendedor)">
      <input id="vl_valor_comissao" placeholder="Comiss√£o padr√£o (R$ ou %)">
      <select id="vl_tipo_comissao">
        <option value="PERCENTUAL">Padr√£o: %</option>
        <option value="FIXO">Padr√£o: R$</option>
      </select>
    </div>

    <button onclick="cadastrarVendedorLoja()">Salvar Vendedor</button>

    <hr>

    <!-- Dados da Venda -->
    <div class="badge">Dados da venda</div>
    <div class="grid">
      <div>
        <label>Data da Venda</label>
        <input id="vd_data" type="date">
      </div>

      <input id="vd_valor_venda" placeholder="Valor da Venda (R$)">

      <select id="vd_forma_pag">
        <option value="">Forma Pagamento</option>
        <option>Dinheiro</option>
        <option>Pix</option>
        <option>Cart√£o</option>
        <option>Financiamento</option>
      </select>

      <select id="vd_condicao">
        <option value="AVISTA">√Ä vista</option>
        <option value="PARCELADO">Parcelado</option>
        <option value="FINANCIADO">Financiado</option>
      </select>

      <input id="vd_entrada" placeholder="Entrada (R$)">
      <input id="vd_parcelas" placeholder="N¬∫ Parcelas">
      <input id="vd_valor_parcela" placeholder="Valor Parcela (R$)">
      <input id="vd_banco" placeholder="Banco (se financiado)">
      <input id="vd_valor_financiado" placeholder="Valor Financiado (R$)">
    </div>

    <hr>

    <!-- Comprador -->
    <div class="badge">Comprador</div>
    <div class="grid">
      <input id="c_nome" placeholder="Nome Comprador">
      <input id="c_doc" placeholder="CPF/CNPJ Comprador">
      <input id="c_telefone" placeholder="Telefone">
      <input id="c_email" placeholder="Email">
      <input id="c_endereco" placeholder="Endere√ßo">
      <input id="c_cidade" placeholder="Cidade">
      <input id="c_estado" placeholder="Estado">
    </div>

    <textarea id="vd_obs" placeholder="Observa√ß√µes"></textarea>

    <button onclick="registrarVenda()">Registrar Venda</button>

  </div>
</div>
<div id="abaProprietario" class="aba" style="display:none;">

  <div class="card">
    <h2>Painel do Propriet√°rio</h2>
    <small>Vis√£o exclusiva de resultados financeiros.</small>

    <div class="grid">
      <div>
        <label>Total Investido em Estoque</label>
        <input id="pr_total_investido" readonly>
      </div>

      <div>
        <label>Total Despesas</label>
        <input id="pr_total_despesas" readonly>
      </div>

      <div>
        <label>Total Vendas</label>
        <input id="pr_total_vendas" readonly>
      </div>

      <div>
        <label>Lucro L√≠quido Geral</label>
        <input id="pr_lucro_total" readonly>
      </div>
    </div>

    <button onclick="carregarPainelProprietario()">Atualizar Dados</button>
<hr style="margin:25px 0;">
<h3>Relat√≥rio de Estoque Atual</h3>
<div id="relatorioEstoqueProprietario"></div>

<hr style="margin:25px 0;">
<h3>Relat√≥rio de Despesas</h3>
<div class="form-row" style="display:flex; gap:15px; align-items:end; margin-bottom:15px;">

  <div style="flex:1;">
    <label>Data Inicial</label>
    <input type="date" id="dataInicioFiltro">
  </div>

  <div style="flex:1;">
    <label>Data Final</label>
    <input type="date" id="dataFimFiltro">
  </div>

  <div>
    <button onclick="filtrarDespesas()" class="btn-success">
      Filtrar
    </button>
  </div>

</div>

<div id="relatorioDespesasProprietario"></div>

<hr style="margin:25px 0;">

<hr style="margin:25px 0;">
<div class="grid" style="margin-bottom:15px;">
  <div>
    <label>Data Inicial</label>
    <input type="date" id="filtro_data_inicio">
  </div>

  <div>
    <label>Data Final</label>
    <input type="date" id="filtro_data_fim">
  </div>

  <div style="display:flex;align-items:flex-end;">
    <button onclick="filtrarPeriodo()" class="btn-success">
    Filtrar
</button>
  </div>
</div>

<h3>Relat√≥rio de Vendas por Vendedor</h3>
<div id="relatorioVendasProprietario"></div>

<button onclick="window.print()">Imprimir</button>

</div>
</div> <!-- üî• FECHAMENTO QUE ESTAVA FALTANDO -->

<div id="abaRelatorio" class="aba" style="display:none;">

  <div class="card">
    <h2>Relat√≥rio de Estoque</h2>
    <div id="relatorioEstoque"></div>

   <button onclick="imprimirRelatorio()">Imprimir</button>
  </div>

</div>
<script>
/* ========= CONFIG ========= */
const GAS_URL = "https://script.google.com/macros/s/AKfycbyDSdfY9ILeSHuqg08mo1ruDA1DzgkN7CKDIswZFwXeoa4d9064m_KrxVI_o1j1_AMn/exec";

/* ========= HELPERS ========= */

function v(id){
  const el=document.getElementById(id);
  return el ? (el.value||"").trim() : "";
}
function num(x){
  if(!x) return 0;
  return Number(String(x).replace(/\./g,'').replace(',','.')) || 0;
}
function toBRDate(iso){ // "2026-02-13" -> "13/02/2026"
  if(!iso) return "";
  const [y,m,d] = String(iso).split("-");
  if(!y || !m || !d) return "";
  return `${d}/${m}/${y}`;
}

function jsonp(params, callback){

  // sempre tenta pegar o cliente_id salvo
  const saved = localStorage.getItem("cliente_id") || "";
  const cid = (CLIENTE_ID && String(CLIENTE_ID).trim()) ? CLIENTE_ID : saved;

  if(cid){
    params.cliente_id = cid;
  }

  const cbName = "cb_" + Date.now() + "_" + Math.floor(Math.random()*1000);
  params.callback = cbName;

  const query = new URLSearchParams(params).toString();
  const script = document.createElement("script");

  window[cbName] = function(data){
    try { callback(data); }
    finally {
      delete window[cbName];
      if(script && script.parentNode) script.parentNode.removeChild(script);
    }
  };

  script.onerror = function(){
    alert("Falha ao chamar o GAS (script.onerror). Verifique URL do GAS ou permiss√£o do WebApp.");
    delete window[cbName];
    if(script && script.parentNode) script.parentNode.removeChild(script);
  };

  script.src = GAS_URL + "?" + query;
  document.body.appendChild(script);
}

function setSelect(el, items, placeholder){
  el.innerHTML = "";
  const op0 = document.createElement("option");
  op0.value = "";
  op0.textContent = placeholder || "Selecione";
  el.appendChild(op0);

  items.forEach(it=>{
    const op = document.createElement("option");
    op.value = it.value;
    op.textContent = it.label;
    el.appendChild(op);
  });
}

/* ========= LOAD LISTAS ========= */
function carregarListas(){
  jsonp({action:"listarVeiculosEstoque"}, (r)=>{
    if(!r.ok) return console.warn(r.msg||"Erro listarVeiculos");
    const items = (r.itens||[]).map(x=>({value:x.id, label:`${x.placa} ‚Äî ${x.marca} ${x.modelo} (${x.status})`}));
    setSelect(document.getElementById("d_id_veiculo"), items, "Selecionar ve√≠culo (estoque)");
    setSelect(document.getElementById("vd_id_veiculo"), items, "Selecionar ve√≠culo (estoque)");
  });

  jsonp({action:"listarVendedoresLojaAtivos"}, (r)=>{
    if(!r.ok) return console.warn(r.msg||"Erro listarVendedores");
    const items = (r.itens||[]).map(x=>({value:x.id, label:`${x.nome} (${x.cargo || "vendedor"})`}));
    setSelect(document.getElementById("vd_vendedor_loja"), items, "Selecionar vendedor da loja");
  });
}
function entrarSistema(){
  document.getElementById("capa").style.display = "none";
}

(function(){
  const d = new Date();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yyyy = d.getFullYear();
  const el = document.getElementById("capaAtualizacao");
  if(el) el.textContent = mm + "/" + yyyy;
})();

/* ========= A√á√ïES ========= */
function salvarEntrada(){

  const payload = {
    action:"cadastrarEntrada",

    placa: v("v_placa"),
    marca: v("v_marca"),
    modelo: v("v_modelo"),
    ano_fabricacao: v("v_ano_fabricacao"),
    ano_modelo: v("v_ano_modelo"),
    cor: v("v_cor"),
    combustivel: v("v_combustivel"),
    chassi: v("v_chassi"),
    renavam: v("v_renavam"),
    valor_compra: num(v("v_valor_compra")),
    valor_venda: num(v("v_valor_venda")),
    tipo_veiculo: v("tipo_veiculo"),

    p_nome:v("p_nome"),
    p_doc:v("p_cpf"),
    p_rg:v("p_rg"),
    p_nascimento:v("p_nascimento"),
    p_telefone:v("p_telefone"),
    p_email:v("p_email"),
    p_endereco:v("p_endereco"),
    p_cidade:v("p_cidade"),
    p_estado:v("p_estado"),
    p_inicio:v("p_inicio"),

    va_nome:v("va_nome"),
    va_doc:v("va_doc"),
    va_telefone:v("va_telefone"),
    va_email:v("va_email"),
    va_endereco:v("va_endereco"),
    va_cidade:v("va_cidade"),
    va_estado:v("va_estado"),
      };

  jsonp(payload, (r)=>{
    if(r.ok){
      alert("Entrada salva! ID ve√≠culo: " + r.id_veiculo);
      limparFormularioEntrada();
      carregarListas();
    } else alert("Erro: " + (r.msg||""));
  });
}
function lancarDespesa(){
  const payload = {
    action:"lancarDespesa",
    id_veiculo:v("d_id_veiculo"),
    data_despesa:v("d_data"),
    tipo_despesa:v("d_tipo"),
    descricao_despesa:v("d_desc"),
    valor_despesa:num(v("d_valor")),
    forma_pagamento:v("d_forma"),
    comprovante:v("d_comprovante")
  };

  if(!payload.id_veiculo) return alert("Selecione o ve√≠culo.");
  if(!payload.data_despesa) return alert("Informe a data da despesa.");
  if(!payload.tipo_despesa) return alert("Informe o tipo da despesa.");
  if(!payload.valor_despesa) return alert("Informe o valor da despesa.");

  jsonp(payload, (r)=>{
    if(r.ok){
      alert("Despesa lan√ßada!");
      limparFormularioDespesa();
    } else alert("Erro: " + (r.msg||""));
  });
}

function cadastrarVendedorLoja(){
  const payload = {
    action:"cadastrarVendedorLoja",
    nome_vendedor_loja: v("vl_nome"),
    cpf_vendedor_loja: v("vl_cpf"),
    telefone_vendedor_loja: v("vl_tel"),
    email_vendedor_loja: v("vl_email"),
    cargo: v("vl_cargo"),
    valor_comissao_padrao: num(v("vl_valor_comissao")),
    tipo_comissao_padrao: v("vl_tipo_comissao")
  };

  if(!payload.nome_vendedor_loja) return alert("Informe o nome do vendedor.");
  if(!payload.cpf_vendedor_loja) return alert("Informe o CPF do vendedor.");

  jsonp(payload, (r)=>{
    if(r.ok){
      alert("Vendedor cadastrado!");
      limparFormularioVendedor();
      carregarListas();
    } else alert("Erro: " + (r.msg||""));
  });
}

function registrarVenda(){
  const id_veiculo = v("vd_id_veiculo");
  if(!id_veiculo) return alert("Selecione o ve√≠culo.");

  const comprador_nome = v("c_nome");
  const comprador_doc = v("c_doc");
  if(!comprador_nome || !comprador_doc) return alert("Sem comprador n√£o existe venda.");

  jsonp({action:"totalDespesasVeiculo", id_veiculo}, (r)=>{
    if(!r.ok) return alert("Erro ao checar despesas.");
    const total = Number(r.total||0);

    if(total === 0){
      if(!confirm("Ve√≠culo sem despesas. Deseja continuar?")) return;
    }
    enviarVenda();
  });
}

function enviarVenda(){
  const tipo_comissao = v("vd_tipo_comissao");
  const percent = num(v("vd_percentual"));
  const valorCom = num(v("vd_valor_comissao"));

  if(tipo_comissao === "PERCENTUAL" && !percent) return alert("Informe o % de comiss√£o.");
  if(tipo_comissao === "FIXO" && !valorCom) return alert("Informe o valor fixo da comiss√£o.");
  if(!v("vd_data")) return alert("Informe a data da venda.");
  if(!num(v("vd_valor_venda"))) return alert("Informe o valor da venda.");

  const payload = {
    action:"registrarVenda",
    id_veiculo:v("vd_id_veiculo"),

    data_venda:v("vd_data"),
    valor_venda:num(v("vd_valor_venda")),
    forma_pagamento:v("vd_forma_pag"),
    condicao_pagamento:v("vd_condicao"),

    entrada:num(v("vd_entrada")),
    numero_parcelas:v("vd_parcelas"),
    valor_parcela:num(v("vd_valor_parcela")),

    banco_financiamento:v("vd_banco"),
    valor_financiado:num(v("vd_valor_financiado")),

    comprador_nome:v("c_nome"),
    comprador_doc:v("c_doc"),
    comprador_telefone:v("c_telefone"),
    comprador_email:v("c_email"),
    comprador_endereco:v("c_endereco"),
    comprador_cidade:v("c_cidade"),
    comprador_estado:v("c_estado"),

    vendedor_loja_id:v("vd_vendedor_loja"),

    tipo_comissao,
    percentual_comissao:percent,
    valor_comissao_fixo:valorCom,

    observacoes:v("vd_obs")
  };

  jsonp(payload, (rr)=>{
    if(rr.ok){
      alert("Venda registrada! ID: " + (rr.id_venda || "(n√£o retornou)") +
            "\nLucro l√≠quido: R$ " + (rr.lucro_liquido||0));
      limparFormularioVenda();
      carregarListas();
    } else {
      alert("Erro: " + (rr.msg||""));
    }
  });
}

/* ===== LIMPEZAS ===== */
function limparFormularioEntrada(){
  document.querySelectorAll("#abaVeiculo input").forEach(el=>el.value="");
  document.getElementById("tipo_veiculo").selectedIndex = 0;
}

function limparFormularioDespesa(){
  document.getElementById("d_data").value = "";
  document.getElementById("d_tipo").value = "";
  document.getElementById("d_desc").value = "";
  document.getElementById("d_valor").value = "";
  document.getElementById("d_forma").selectedIndex = 0;
  document.getElementById("d_comprovante").value = "";
}
function limparFormularioVendedor(){
  document.querySelectorAll("#abaVenda #vl_nome, #abaVenda #vl_cpf, #abaVenda #vl_tel, #abaVenda #vl_email, #abaVenda #vl_cargo, #abaVenda #vl_valor_comissao")
    .forEach(el=>el.value="");
  document.getElementById("vl_tipo_comissao").selectedIndex = 0;
}
function limparFormularioVenda(){
  document.querySelectorAll("#abaVenda input, #abaVenda textarea, #abaVenda select")
    .forEach(el=>{
      if(el.tagName === "SELECT") el.selectedIndex = 0;
      else el.value = "";
    });
}
function carregarPainelProprietario(){

  // ===== RESUMO FINANCEIRO =====
  jsonp({action:"resumoFinanceiro"}, (r)=>{
  if(!r || !r.ok){
    console.log("RESUMO ERRO:", r);
    return alert("Erro ao carregar resumo: " + (r?.msg || "sem msg do GAS"));
  }


    document.getElementById("pr_total_investido").value = r.capital_em_estoque || 0;
    document.getElementById("pr_total_despesas").value = r.total_despesas || 0;
    document.getElementById("pr_total_vendas").value = r.total_vendido || 0;
    document.getElementById("pr_lucro_total").value = r.lucro_realizado || 0;
  });

  // ===== RELAT√ìRIO ESTOQUE =====
  jsonp({action:"relatorioEstoque"}, (r)=>{
    if(!r.ok) return;

    let html = "<table border='1' width='100%' cellspacing='0' cellpadding='6'>";
    html += `
    <tr>
      <th>Placa</th>
      <th>Marca</th>
      <th>Modelo</th>
      <th>Ano Fab</th>
      <th>Ano Mod</th>
      <th>Cor</th>
      <th>Tipo</th>
      <th>Valor Venda</th>
      <th>Data Entrada</th>
    </tr>`;

    r.itens.forEach(v=>{
      html += `
      <tr>
        <td>${v.placa}</td>
        <td>${v.marca}</td>
        <td>${v.modelo}</td>
        <td>${v.ano_fabricacao || ""}</td>
        <td>${v.ano_modelo || ""}</td>
        <td>${v.cor || ""}</td>
        <td>${v.tipo_veiculo || ""}</td>
        <td>R$ ${v.valor_venda || 0}</td>
        <td>${v.data_entrada || ""}</td>
      </tr>`;
    });

    html += "</table>";
    document.getElementById("relatorioEstoqueProprietario").innerHTML = html;
  });

  // ===== RELAT√ìRIO DESPESAS =====
  const dataInicio = document.getElementById("filtro_data_inicio").value;
const dataFim = document.getElementById("filtro_data_fim").value;

jsonp({
  action:"relatorioDespesasGeral",
  data_inicio:dataInicio,
  data_fim:dataFim
}, (r)=>{

    if(!r.ok) return;

    let html = "<table border='1' width='100%' cellspacing='0' cellpadding='6'>";
    html += `
    <tr>
      <th>Ve√≠culo</th>
      <th>Data</th>
      <th>Tipo</th>
      <th>Valor</th>
    </tr>`;

    r.itens.forEach(d=>{
      html += `
      <tr>
        <td>${d.placa}</td>
        <td>${d.data_despesa}</td>
        <td>${d.tipo_despesa}</td>
        <td>R$ ${d.valor_despesa}</td>
      </tr>`;
    });

    html += "</table>";
    document.getElementById("relatorioDespesasProprietario").innerHTML = html;
  });

  // ===== RELAT√ìRIO VENDAS POR VENDEDOR =====
  jsonp({action:"relatorioVendasPorVendedor"}, (r)=>{
    if(!r.ok) return;

    let html = "<table border='1' width='100%' cellspacing='0' cellpadding='6'>";
    html += `
<tr>
  <th>Vendedor</th>
  <th>Data</th>
  <th>Valor Venda</th>
  <th>Lucro</th>
</tr>`;

    r.itens.forEach(v=>{
      html += `
      <tr>
       <td>${v.vendedor_nome}</td>
<td>${v.data_venda}</td>
<td>R$ ${v.valor_venda}</td>
<td>R$ ${v.lucro}</td>

      </tr>`;
    });

    html += "</table>";
    document.getElementById("relatorioVendasProprietario").innerHTML = html;
  });
}
function carregarRelatorioVendasFiltrado(){
  const dataInicio = document.getElementById("filtro_data_inicio").value;
  const dataFim = document.getElementById("filtro_data_fim").value;


  jsonp({
    action:"relatorioVendasPorVendedor",
    data_inicio:dataInicio,
    data_fim:dataFim
  }, (r)=>{

    if(!r.ok) return alert("Erro ao filtrar vendas.");

    let html = "<table border='1' width='100%' cellspacing='0' cellpadding='6'>";
    html += `
    <tr>
      <th>Vendedor</th>
      <th>Data</th>
      <th>Valor Venda</th>
      <th>Lucro</th>
    </tr>`;

    r.itens.forEach(v=>{
      html += `
      <tr>
        <td>${v.vendedor_nome}</td>
        <td>${v.data_venda}</td>
        <td>R$ ${v.valor_venda}</td>
        <td>R$ ${v.lucro}</td>
      </tr>`;
    });

    html += "</table>";

    document.getElementById("relatorioVendasProprietario").innerHTML = html;

  });
}
function carregarRelatorioDespesasFiltrado(){
  const dataInicio = document.getElementById("filtro_data_inicio").value;
  const dataFim = document.getElementById("filtro_data_fim").value;

  jsonp({
    action:"relatorioDespesasGeral",
    data_inicio: toBRDate(dataInicio),
    data_fim: toBRDate(dataFim)
  }, (r)=>{
    if(!r.ok) return alert("Erro ao filtrar despesas.");

    let html = "<table border='1' width='100%' cellspacing='0' cellpadding='6'>";
    html += `
      <tr>
        <th>Ve√≠culo</th>
        <th>Data</th>
        <th>Tipo</th>
        <th>Valor</th>
      </tr>`;

    (r.itens||[]).forEach(d=>{
      html += `
        <tr>
          <td>${d.placa}</td>
          <td>${d.data_despesa}</td>
          <td>${d.tipo_despesa}</td>
          <td>R$ ${d.valor_despesa}</td>
        </tr>`;
    });

    html += "</table>";
    document.getElementById("relatorioDespesasProprietario").innerHTML = html;
  });
}

function acessarProprietario(){
  const senha = prompt("Informe a senha do propriet√°rio:");
  if(!senha) return;

  jsonp({action:"validarSenhaProprietario", senha}, (r)=>{
    if(r.ok){
      abrirAba('abaProprietario');
    } else {
      alert("Senha incorreta.");
    }
  });
}

function abrirAba(id){
  document.querySelectorAll(".aba").forEach(el=>{
    el.style.display = "none";
  });
  document.getElementById(id).style.display = "block";

  if(id === "abaRelatorio"){
    carregarRelatorios();
  }
}

function imprimirRelatorio(){
  window.print();
}
function carregarRelatorios(){

  jsonp({action:"relatorioEstoque"}, (r)=>{
    if(!r.ok) return;

    let html = "<table border='1' width='100%' cellspacing='0' cellpadding='6'>";
html += `
<tr>
  <th>Placa</th>
  <th>Marca</th>
  <th>Modelo</th>
  <th>Ano Fab</th>
  <th>Ano Mod</th>
  <th>Cor</th>
  <th>Tipo</th>
  <th>Valor Venda</th>
  <th>Data Entrada</th>
</tr>
`;


    r.itens.forEach(v=>{
  html += `
<tr>
  <td>${v.placa}</td>
  <td>${v.marca}</td>
  <td>${v.modelo}</td>
  <td>${v.ano_fabricacao}</td>
  <td>${v.ano_modelo}</td>
  <td>${v.cor}</td>
  <td>${v.tipo_veiculo}</td>
  <td>R$ ${v.valor_venda}</td>
  <td>${v.data_entrada}</td>
</tr>
`;
});

    html += "</table>";
    document.getElementById("relatorioEstoque").innerHTML = html;
  });

}

function abrirFichaBranca(){
  window.open("ficha_branca.html", "_blank");
}
let CLIENTE_ID = "";
let PERFIL = "";

function fazerLogin(){

  const usuario = v("login_usuario");
  const senha = v("login_senha");

  if(!usuario || !senha) return alert("Informe usu√°rio e senha.");

  jsonp({
    action:"loginUsuario",
    usuario,
    senha
  }, (r)=>{

if(r.ok){

  CLIENTE_ID = r.cliente_id;
  PERFIL = r.perfil;

  localStorage.setItem("cliente_id", r.cliente_id);
  localStorage.setItem("nome_loja", r.nome_loja || "AutoControle");

  document.getElementById("nomeLojaTopo").innerText =
  r.nome_loja || "Loja";

  document.getElementById("telaLogin").style.display = "none";

  carregarListas();
    } else {
      alert(r.msg || "Erro login");
    }

  });
}
// ===== RESTORE AUTOM√ÅTICO COMPLETO =====
window.addEventListener("DOMContentLoaded", function(){

  const clienteSalvo = localStorage.getItem("cliente_id");
  const nomeSalvo = localStorage.getItem("nome_loja");

  if(clienteSalvo){
    CLIENTE_ID = clienteSalvo;
    document.getElementById("telaLogin").style.display = "none";
    carregarListas();
  }

  if(nomeSalvo){
    document.getElementById("nomeLojaTopo").innerText = nomeSalvo;
  }

});

function filtrarPainelProprietario(){
  carregarRelatorioVendasFiltrado();
  carregarRelatorioDespesasFiltrado();
}
function filtrarPeriodo() {

  const dataInicio = document.getElementById("dataInicioFiltro").value;
  const dataFim = document.getElementById("dataFimFiltro").value;

  if (!dataInicio || !dataFim) {
    alert("Informe a data inicial e final");
    return;
  }

  jsonp({
    action: "resumoPorPeriodo",
    data_inicio: dataInicio,
    data_fim: dataFim
  }, function(res){

    if(!res || !res.ok){
      alert("Erro ao filtrar per√≠odo");
      return;
    }

    document.getElementById("pr_total_investido").value = res.totalInvestido || 0;
    document.getElementById("pr_total_despesas").value = res.totalDespesas || 0;
    document.getElementById("pr_total_vendas").value = res.totalVendas || 0;
    document.getElementById("pr_lucro_total").value = res.lucro || 0;

  });

}
</script>

</body>
</html>
